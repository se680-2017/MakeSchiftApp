<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Welcome to MakeSchift</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.12.2/css/bootstrap-select.min.css"/>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <script src="https://unpkg.com/react@15/dist/react.js"></script>
    <script src="https://unpkg.com/react-dom@15/dist/react-dom.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.23/browser.min.js"></script>
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.7.20.min.js"></script>
    <script type="text/javascript" th:src="@{/javascript/keys.js}"></script>

    <!-- Latest compiled and minified CSS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.12.2/js/bootstrap-select.min.js"></script>

    <!-- (Optional) Latest compiled and minified JavaScript translation files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.12.2/js/i18n/defaults-*.min.js"></script>



    <style>
 /* USER PROFILE PAGE */
body{
  background-color: #f77a5b;
}
 .card {
    padding: 30px;
    background-color: rgba(214, 224, 226, 0.2);

}
.card.hovercard {
    position: relative;
    padding-top: 0;
    overflow: hidden;
    text-align: center;
    background-color: #fff;
    background-color: rgba(255, 255, 255, 1);
}
.card.hovercard .card-background {
    height: 150px;
}
.card-background img {
    -webkit-filter: blur(25px);
    -moz-filter: blur(25px);
    -o-filter: blur(25px);
    -ms-filter: blur(25px);
    filter: blur(25px);
    margin-left: -100px;
    margin-top: -200px;
    min-width: 130%;
}
.card.hovercard .useravatar {
    position: absolute;
    top: 15px;
    left: 0;
    right: 0;
}
.card.hovercard .useravatar img {
    width: 150px;
    height: 150px;
   
    -webkit-border-radius: 50%;
    -moz-border-radius: 50%;
    border-radius: 50%;
    border: 5px solid rgba(255, 255, 255, 0.5);
}
.card.hovercard .card-info {
    position: absolute;
    bottom: 14px;
    left: 0;
    right: 0;
}
.card.hovercard .card-info .card-title {
    padding:0 5px;
    font-size: 30px;
    line-height: 1;
    color: #262626;
    background-color: rgba(255, 255, 255, 0.1);
    -webkit-border-radius: 4px;
    -moz-border-radius: 4px;
    border-radius: 4px;
}
.card.hovercard .card-info {
    overflow: hidden;
    font-size: 12px;
    line-height: 20px;
    color: #737373;
    text-overflow: ellipsis;
}
.card.hovercard .bottom {
    padding: 0 20px;
    margin-bottom: 17px;
    
}
.btn-pref .btn {
    -webkit-border-radius:0 !important;
  
}

.well{
  background-color: #f79a79;
}

.downloadTable{
color: #4286f4;
font-weight:bold;

}

.th{
text-align: right;
}


table.downloadTable{

     border-radius: 15px;
margin: 0 auto;
     width: 980px;
    


    background-color: #ffffff;

}

tr.downloadableRow{

border-radius: 15px;
background-color: #dabcdd;
}

 td.downloadableCell{
border-radius: 15px;
     background-color: #ffffff;
     border: 1px solid grey;
     width:450px;
font-weight: bold;
 }
 a.downloadableLink{
     color: black;
     width 250px;
 }
 a.accessButton{
     -webkit-appearance: button;
     -moz-appearance: button;
     appearance: button;
     text-decoration: none;
     color: initial;
 }
td.downloadableMessage{

    border: 1px solid grey;
}
td.deadlineCell{
background-color: #e5e3e3;
border-radius: 2px;
    border: 1px solid grey;
    padding-right:20px;
     padding-left: 20px;
     font-weight: normal;
     color: black;

}
td.countdownCell{
background-color: #e5e3e3;
border-radius: 2px;
    border: 1px solid grey;
    padding-right:20px;
     padding-left: 20px;
     font-weight: normal;
     color: black;
}
 td.downloadButtonCell{
     background-color: #e5e3e3;
     border-radius: 2px;
     border: 1px solid grey;

     color: #4286f4;

 }
 td.deleteButtonCell{
     background-color: #e5e3e3;
     border-radius: 2px;
     border: 1px solid grey;
     color: red;
 }
 p.filenameText{
     margin: 0px;
     color: black;
     width 250px;
     font-weight: bold;
 }



    </style>
</head>
<body>

<script> 
$(document).ready(function() {
$(".btn-pref .btn").click(function () {
    $(".btn-pref .btn").removeClass("btn-primary").addClass("btn-default");
    $(this).removeClass("btn-default").addClass("btn-primary");
});
});
</script>
 
<div class="cardboard">
    <div class="card hovercard">
        <div class="card-background">
            <img class="card-bkimg" alt="" src="http://pictures.topspeed.com/IMG/crop/201608/lamborghini-aventado-10_600x0w.jpg"/>
        </div>
        <div class="useravatar" style="padding-left:70px;">
            <form style="float:right" th:action="@{/logout}" method="post">
                <input type="submit" value="Sign Out"/>
            </form>
            <img  alt="" src="http://pictures.topspeed.com/IMG/crop/201608/lamborghini-aventado-10_600x0w.jpg"/>
        </div>
        <div class="card-info">
            <span class="card-title" th:inline="text">[[${#httpServletRequest.remoteUser}]]</span>
        </div>
    </div>
    <div class="btn-pref btn-group btn-group-justified btn-group-lg" role="group" aria-label="...">
        <div class="btn-group" role="group">
            <button type="button" id="stars" class="btn btn-primary" href="#tab1" data-toggle="tab"><span class="glyphicon glyphicon-user" aria-hidden="true"></span>
                <div class="hidden-xs">Profile</div>
            </button>
        </div>
        <div class="btn-group" role="group">
            <button type="button" id="favorites" class="btn btn-default" href="#tab2" data-toggle="tab"><span class="glyphicon glyphicon-inbox" aria-hidden="true"></span>
                <div class="hidden-xs">Inbox</div>
            </button>
        </div>
        <div class="btn-group" role="group">
            <button type="button" id="following" class="btn btn-default" href="#tab3" data-toggle="tab"><span class="glyphicon glyphicon-envelope" aria-hidden="true"></span>
                <div class="hidden-xs">Files Sent</div>
            </button>
        </div>
    </div>
    <div class="well" >
<!--the following div displays the members on the home page-->


         <div class="tab-content" style="text-align: center;">
             <!-- Tab 1: Mechanism for uploading the file -->
             <div class="tab-pane fade in active" id="tab1">
                 <script>
                     // Had to write this code to rebuild the FilePicker widget.
                     // constructWidget() and its behavior was NOT documented in the API :(
                     var fromUser = "user1/";
                     var toUser = "noRecepient/";
                     var expDate = "1845000000/";
                     var uploadDuration = 30;
                     function rebuildWidget() {
                         expDate =  encodeURIComponent( Math.floor((new Date().getTime())/1000) + parseInt(uploadDuration) ) + '/';
                         var element = document.getElementById('fpButton');
                         element.type = "filepicker";
                         element.setAttribute('data-fp-mimetypes', '*/*');
                         element.setAttribute('data-fp-store-path', toUser+fromUser+expDate );
                         element.setAttribute('data-fp-container', 'modal');
                         element.setAttribute('data-fp-store-access', 'public');
                         element.setAttribute('data-fp-store-location', 'S3');
                         // Gotta remove old button
                         var oldButton = document.getElementsByClassName( "fp__btn" );
                         oldButton[0].parentNode.removeChild(oldButton[0]);
                         filepicker.constructWidget(element);
                     }
                 </script>
                 <!--Takes the username used to sign in and displays it in the homepage-->
                 <h1>Upload and Send a File to a Friend!</h1>
                 <br/>
                 <!-- FileStack library and API. Note: data-fp-apikey="" is left empty for security reasons since
                      code will be made public on github -->
                 <script type="text/javascript" src="//api.filestackapi.com/filestack.js" ></script>

                 <script>
                     function myfunc(){
                         alert(event.fpfile.url) ;
                         console.log("i got here yaaaay");
                         document.getElementById("link").value=event.fpfile.url;
                     }
                 </script>
<div id="uploadControls" style="display:inline-block;">
                     <input  id="fpButton" type="filepicker" data-fp-mimetypes="*/*" data-fp-store-path="mofo/"
                             data-fp-container="modal" data-fp-store-access="public" data-fp-store-location="S3" onchange="myfunc()" />

                     <script type="text/javascript">
                         document.getElementById('fpButton').setAttribute( 'data-fp-apikey', filepickerKey );
                     </script>
                     <script>
                         $(document).ready(function() {
                             $("#userDropDown").change(function () {
                                 var e = document.getElementById("userDropDown");
                                 toUser = encodeURIComponent( e.options[e.selectedIndex].text ) + '/';
                                 rebuildWidget();
                             });
                             $("#timeDropDown").change(function () {
                                 var e = document.getElementById("timeDropDown");
                                 uploadDuration = e.options[e.selectedIndex].value;
                                 rebuildWidget();
                             });
                         });
                     </script>

    <select id="userDropDown" style="margin-left:10px;" >
        <option>Select Member</option>
        <option>user1</option>
        <option>user2</option>
        <option th:each="user : ${userCollection}">
            <td th:text="${user.username}"></td>
        </option>
    </select>

    <select id="timeDropDown" style="margin-left:10px;" >
        <option value="0">Select Lifespan</option>
        <option value="30">30 seconds</option>
        <option value="120">2 minutes</option>
        <option value="3600">1 hour</option>
        <option value="86400">1 day</option>
        <option value="345600">2 weeks</option>
    </select>

    <script>
        $('.selectpicker').selectpicker({
  style: 'btn-info',
  size: 4
});

    </script>
</div>

             </div>

             <!-- Tab 2: List of files the user can download and their remaining time -->
             <div class="tab-pane fade in" id="tab2">
                 <script>
                     var options = {
                         accessKeyId: akid,
                         secretAccessKey: secretKey,
                         region: 'us-east-1',
                         apiVersion: '2006-03-01'
                     };
                     var bucketName = 'makeschiftbucket';
                     function iGotThis( objName ) {
                         console.log( "I can take care of that for ya" );
                         var s3 = new AWS.S3( options );
                         var params = {
                             Bucket: bucketName,
                             Key: 'user1/' + objName
                         };
                         s3.deleteObject( params, function(err,data) {
                             if (err) {
                                 console.log( "of course I couldn't delete " + objName );
                                 console.log(err, err.stack);
                             }
                             else {
                                 console.log( "OK status from delete: " + objName );
                             }
                         });
                     }
                 </script>
                 <script type="text/babel" th:inline="javascript">
                     var userID = [[${#httpServletRequest.remoteUser}]];
                     var userDir = encodeURIComponent( userID ) + '/';
                     var bucketName = 'makeschiftbucket';
                     var bucketURL = 'https://s3.amazonaws.com/'
                                   + encodeURIComponent( bucketName ) + '/';
                     var userURL = bucketURL + userDir;
                     var options = {
                         accessKeyId: akid,
                         secretAccessKey: secretKey,
                         region: 'us-east-1',
                         apiVersion: '2006-03-01'
                     }

                     var downloadablesInBucket = [[testvar, Math.floor(new Date(2017,7,29,22,59)/1000)]];

                     // DownloadableTableRow
                     // This represents one downloadable element in the Downloadable Table.
                     // It tracks its own time, and deletes itself once time expires.
                     // At the moment this deletion only hides itself from the webgui.
                     // TODO: Display info from new directory structure to new columns
                     class DownloadableTableRow extends React.Component {
                         constructor( props ){
                             super( props );
                             this.state = {
                                 countdown: this.timeLeft(),
                                 deleteFlag: false
                             };
                             this.selfDelete = this.selfDelete.bind( this );
                         }
                         fullUrl() {
                             return userURL + this.props.filename
                         }
                         deadlineMessage(){
                             return this.props.deadline.toLocaleString()
                         }
                         countdownMessage(){
                             return this.state.countdown
                         }
                         selfDownload(){
                             console.log("Clicked download.");//this.setState( {deleteFlag: true} )
                         }
                         selfDelete(){
                             var killMe = this.props.filename;
                             console.log( killMe );
                             iGotThis( killMe );
                             this.setState( {deleteFlag: true} )
                         }
                         timeLeft(){
                             var deadline_ms = this.props.deadline.getTime();
                             var rightnow_ms = new Date().getTime();
                             var millis_left = deadline_ms - rightnow_ms;
                             (millis_left > 0) ? false : this.selfDelete(); // because thymeleaf hates my if statements
                             return Math.floor(millis_left/3600000) + "h "
                                 + (Math.floor(millis_left/60000))%60 + "m "
                                 + (Math.floor(millis_left/1000))%60 + "s remaining"
                         }
                         componentDidMount() {
                             this.timerID = setInterval(
                                 () => this.tick(),
                                 1000
                             );
                         }
                         componentWillUnmount() {
                             clearInterval(this.timerID);
                         }
                         tick() {
                             this.setState({
                                 countdown: this.timeLeft()
                             });
                         }
                         render () {
                             if( this.state.deleteFlag ){
                                 return null;
                             }
                             const dlUrl = this.fullUrl();
                             return React.createElement(
                                 'tr', {className: "downloadableRow"},
                                 React.createElement(
                                     'td', {className: "downloadableCell"},
                                     React.createElement( 'p', { className: "filenameText" }, this.props.filename )
                                 ),
                                 React.createElement(
                                     'td', { className: "deadlineCell" }, this.deadlineMessage()
                                 ),
                                 React.createElement(
                                     'td', { className: "countdownCell" }, this.countdownMessage()
                                 ),
                                 React.createElement(
                                     'td', { className: "downloadButtonCell" },
                                     React.createElement( 'a', { className: "btn btn-primary", href: dlUrl, target: "_blank", onClick: this.selfDownload}, "Access" )
                                 ),
                                 React.createElement(
                                     'td', { className: "deleteButtonCell" },
                                     React.createElement( 'button', { className: "btn btn-danger", onClick: this.selfDelete}, 'Delete' )
                                 )
                             );
                         }
                     }

                     // DownloadableTable
                     // This Table lists all downloadable files.
                     // Under the hood, it is polling the AWS bucket every 5 seconds for new files.
                     class DownloadableTable extends React.Component {
                         constructor( props ){
                             super( props );
                             this.state = {
                                 filelist: this.listObjs()
                             };
                         }
                         listObjs() {
                             // This whole function should probably only update state.filelist
                             // AWS JS could probably be called separately?
                             var s3 = new AWS.S3( options );
                             var params = {
                                 Prefix: userDir,
                                 Bucket: bucketName
                             };
                             s3.listObjectsV2( params, function(err,data) {
                                 if (err) {
                                     console.log(err, err.stack);
                                 }
                                 else{
                                     // downloadablesInBucket is a global variable.
                                     // This is bad.  Needs a real async solution.
                                     downloadablesInBucket = [];
                                     data.Contents.forEach( function(fn) {
                                         if( fn.Key.charAt(fn.Key.length-1) != '/' ){  // exclude directories
                                             var paths = fn.Key.split('/');
                                             if( paths.length == 4 ){ // number of expected filepath elements
                                                 //console.log( paths[2] ) // should be epoch-seconds
                                             }
                                             downloadablesInBucket.push( [
                                                 fn.Key.replace( userDir, '' ), // TODO: fix abridged filename
                                                 paths[2] // deadline
                                                 ]
                                             );
                                         }
                                     })
                                 }
                             });
                             return downloadablesInBucket;
                         }
                         componentDidMount() {
                             this.timerID = setInterval(
                                 () => this.tick(),
                                 5000
                             );
                         }
                         componentWillUnmount() {
                             clearInterval(this.timerID);
                         }
                         tick() {
                             this.setState({
                                 filelist: this.listObjs()
                             });
                             console.log("Logging active.")
                         }
                         render () {
                             const tableHead = <thead><tr className="downloadableHeaderRow" >
                                                   <td>Filename</td><td>Deadline</td><td>Time Left</td><td></td>
                                               </tr></thead>;
                             return React.createElement(
                                 'table',
                                 {className: 'downloadTable'},
                                 tableHead,
                                 React.createElement(
                                     'tbody',
                                     {},
                                     this.state.filelist.map( ([fname,fdate]) =>
                                         React.createElement(DownloadableTableRow, {
                                             filename: fname,
                                             deadline: new Date( parseInt( fdate ) * 1000 )
                                         })
                                     )
                                 )
                             );
                         }
                     }

                     ReactDOM.render( React.createElement(DownloadableTable, {} ), document.getElementById('tab2') );
                 </script>
             </div>

             <!-- Tab 3: List of files the user has uploaded and their status -->
             <div class="tab-pane fade in" id="tab3">
                 <h3>This is tab 3</h3>
             </div>

         </div>
    </div>
</div>

</body>
</html>
